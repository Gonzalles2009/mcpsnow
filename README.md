# Простой доступ к Snowflake для ИИ-помощника (с поддержкой MCP)

Эта штука позволяет вашему ИИ-помощнику (например, в Cursor IDE, Claude Desktop или другом клиенте, поддерживающем Model Context Protocol - MCP) безопасно заглядывать в вашу базу данных Snowflake и получать оттуда информацию.

## Что нужно заранее?

Прежде чем начать, убедитесь, что у вас есть:

1.  **Клиент с поддержкой MCP:** Например, Cursor IDE или Claude Desktop. Установленный и рабочий.
2.  **Аккаунт Snowflake:** Вам нужны данные для входа (Account ID, Имя пользователя, Пароль, База данных, Схема, Warehouse). Получите их у того, кто вам дал доступ к Snowflake.
3.  **Инструмент Go:** Это язык программирования. Если у вас его нет, его нужно установить. Инструкции по установке ниже, в разделе "Сборка программы".
4.  **Код этой программы:** Все файлы из этого репозитория должны быть скачаны и находиться в одной папке (например, `mcpsnow`).

## Как запустить (По шагам)

Делаем все аккуратно, шаг за шагом:

**Шаг 1: Установка Go (если еще не установлен)**

*   Перейдите на официальный сайт Go: [golang.dev/dl/](https://golang.dev/dl/)
*   Скачайте установщик для вашей операционной системы (Windows, macOS, Linux).
*   Запустите установщик и следуйте его инструкциям. Обычно достаточно нажимать "Далее".
*   После установки откройте **новый** Терминал (как в Шаге 2) и введите команду `go version`. Если вы видите версию Go (например, `go version go1.23.0 darwin/amd64`), значит, установка прошла успешно.

**Шаг 2: Открываем Терминал**

*   Терминал — это такая программа для ввода команд текстом.
*   На macOS: Откройте `Launchpad` (значок ракеты), в поиске введите "Терминал" и запустите его.
*   На Windows: Нажмите `Win` + `R`, введите `cmd` и нажмите Enter.
*   Вы увидите черное (или белое) окно, куда можно вводить команды.

**Шаг 3: Заходим в папку с программой**

*   Нужно сказать Терминалу, где лежит наша программа.
*   Скопируйте команду ниже, заменив `/полный/путь/к/папке/mcpsnow` на реальный путь к папке, где лежат файлы этой программы (например, `/Users/aleksandrkud/DevProj/mcpsnow`).
    ```bash
    cd /полный/путь/к/папке/mcpsnow 
    ```
*   Вставьте эту команду в Терминал и нажмите Enter.

**Шаг 4: Сборка программы**

*   Теперь нужно из исходного кода сделать готовую программу, которую поймет компьютер.
*   Скопируйте и вставьте эту команду в Терминал (убедитесь, что вы все еще в папке проекта):
    ```bash
    go build -tags netgo -o mcp_snowflake_server main.go
    ```
*   Нажмите Enter. Если все хорошо, никаких сообщений не будет, но в папке появится новый файл `mcp_snowflake_server` (или `mcp_snowflake_server.exe` на Windows).
    *   *(Пояснение для любопытных: `-tags netgo` - это специальный флажок, чтобы программа лучше работала с сетью в некоторых средах).* 

**Шаг 5: Настраиваем ваш MCP клиент (Cursor, Claude Desktop и т.д.)**

*   Нужно сказать вашему клиенту (Cursor, Claude Desktop...), где найти нашу программу и как к ней подключиться. Это делается через специальный конфигурационный файл.
*   **Для Cursor IDE:**
    *   Откройте папку с вашим проектом (где лежит `mcpsnow`) в Cursor.
    *   Найдите в дереве файлов слева папку `.cursor` (она может быть скрытой). Если ее нет, создайте.
    *   Внутри папки `.cursor` создайте (или откройте, если уже есть) файл с именем `mcp.json`.
*   **Для Claude Desktop:**
    *   Найдите файл конфигурации `claude_desktop_config.json`. Обычно он находится:
        *   На macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
        *   На Windows: `%APPDATA%\Claude\claude_desktop_config.json`
*   **Для других клиентов:** Обратитесь к документации вашего клиента, чтобы найти его файл конфигурации MCP серверов.

*   **Общий формат конфигурации:** Откройте найденный конфигурационный файл (`mcp.json`, `claude_desktop_config.json` и т.п.) и добавьте (или измените существующую) секцию `mcpServers`, чтобы она выглядела так:

    ```json
    {
      "mcpServers": {
        // ... могут быть другие ваши серверы ...
        "snowflake": {
          "command": "/ЗАМЕНИТЕ/ЭТО/НА/ПОЛНЫЙ/ПУТЬ/К/mcpsnow/mcp_snowflake_server",
          "env": {
            "SNOWFLAKE_ACCOUNT": "ВАШ_SNOWFLAKE_ACCOUNT_ID", 
            "SNOWFLAKE_USER": "ВАШЕ_ИМЯ_ПОЛЬЗОВАТЕЛЯ",
            "SNOWFLAKE_PASSWORD": "ВАШ_ПАРОЛЬ",
            "SNOWFLAKE_DATABASE": "ИМЯ_БАЗЫ_ДАННЫХ",
            "SNOWFLAKE_SCHEMA": "ИМЯ_СХЕМЫ",
            "SNOWFLAKE_WAREHOUSE": "ИМЯ_WAREHOUSE"
            // "SNOWFLAKE_ROLE": "ваша_роль" // Опционально
          }
        }
        // ... могут быть другие ваши серверы ...
      }
    }
    ```
*   **Очень важно:**
    1.  Замените `/ЗАМЕНИТЕ/ЭТО/НА/ПОЛНЫЙ/ПУТЬ/К/mcpsnow/mcp_snowflake_server` на **полный абсолютный путь** к файлу `mcp_snowflake_server` (или `mcp_snowflake_server.exe` на Windows), который вы собрали на Шаге 4. Например: `/Users/aleksandrkud/DevProj/mcpsnow/mcp_snowflake_server`.
    2.  Замените `ВАШ_SNOWFLAKE_ACCOUNT_ID`, `ВАШЕ_ИМЯ_ПОЛЬЗОВАТЕЛЯ`, `ВАШ_ПАРОЛЬ` и т.д. на ваши **настоящие данные** для входа в Snowflake.
*   Сохраните конфигурационный файл.

**Шаг 6: Перезапускаем ваш MCP клиент**

*   Полностью закройте программу (Cursor, Claude Desktop...) и запустите ее снова. Это нужно, чтобы она увидела новые настройки.

**Шаг 7: Проверяем настройки в клиенте**

*   В вашем клиенте (Cursor, Claude Desktop...) найдите раздел настроек, где отображаются подключенные MCP серверы (например, `Settings` -> `MCP Servers` в Cursor).
*   Вы должны увидеть там сервер "snowflake". Рядом с ним должен быть индикатор успешного подключения (например, зеленый кружок) и должен быть указан доступный инструмент `execute_query`.

**Готово! Если все шаги выполнены правильно, ваш ИИ-помощник теперь может общаться с Snowflake.**

## Как использовать в чате

Просто попросите помощника что-нибудь сделать с базой данных Snowflake:

*   "Покажи мне все базы данных в Snowflake."
*   "Можешь выполнить запрос `SELECT email FROM users LIMIT 5` в Snowflake?"
*   "Узнай структуру таблицы `products` в Snowflake."

Помощник сам поймет, что нужно использовать настроенный вами сервер `snowflake` и его инструмент `execute_query`.

## Если что-то не работает

*   **Индикатор подключения не горит / Сервер не виден в настройках?**
    *   Перепроверьте **полный путь** к программе в конфигурационном файле (Шаг 5). Ошибки в пути - частая причина.
    *   Убедитесь, что вы точно перезапустили ваш MCP клиент после сохранения конфигурации (Шаг 6).
    *   Проверьте еще раз команду сборки на Шаге 4 (нужен флаг `-tags netgo`). Попробуйте собрать программу снова.
    *   Перепроверьте **все данные для входа** в Snowflake в конфигурационном файле (Шаг 5). Может быть, где-то опечатка?
    *   Проверьте логи вашего MCP клиента (например, `View` -> `Output` -> `Cursor MCP` в Cursor) на наличие ошибок при попытке запуска сервера.
*   **Помощник говорит, что не может выполнить запрос?**
    *   Возможно, у вашего пользователя Snowflake недостаточно прав. Уточните у того, кто давал вам доступ.
    *   Помните: эта программа умеет только *смотреть* данные (`SELECT`, `SHOW`), но не изменять (`INSERT`, `UPDATE`, `DELETE`). Если вы просите что-то изменить, она откажется – это для безопасности.

## Как добавить новые команды для ИИ (Расширение функциональности)

Сейчас помощник умеет только выполнять произвольные SQL-запросы (`execute_query`). Но можно научить его и другим вещам, например, показывать список таблиц или получать схему конкретной таблицы.

Если вы немного знакомы с программированием на Go, вот как это сделать:

1.  **Откройте файл `main.go`** в текстовом редакторе или IDE.
2.  **Найдите место, где определяется инструмент `execTool`**: Это будет блок кода, начинающийся примерно так: `execTool := mcp.NewTool(...)`.
3.  **По аналогии добавьте определение нового инструмента:**
    *   Придумайте ему имя (например, `list_tables`).
    *   Задайте описание, понятное для ИИ (например, "Получить список таблиц в текущей схеме Snowflake").
    *   Определите, какие параметры ему нужны (если нужны). Например, для списка таблиц параметры могут не понадобиться.
    *   Примерно так:
        ```go
        listTablesTool := mcp.NewTool(
            "list_tables", // Имя инструмента для ИИ
            mcp.WithDescription("Получить список таблиц в текущей схеме Snowflake"),
            // Здесь можно добавить параметры mcp.WithString, mcp.WithInteger и т.д., если нужны
        )
        ```
4.  **Добавьте обработчик для нового инструмента:**
    *   Найдите строку `s.AddTool(execTool, func(...) { ... })`.
    *   Ниже добавьте похожий блок для вашего нового инструмента:
        ```go
        s.AddTool(listTablesTool, func(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
            log.Printf("Received tool call request: Method=%s, Params=%+v", request.Method, request.Params)
            
            // 1. Получите нужные параметры из request.Params.Arguments (если они есть)
            // 2. Сформируйте и выполните соответствующий SQL-запрос к Snowflake
            //    (например, "SHOW TABLES IN SCHEMA <ваша_схема>") используя переменную `db`.
            //    Не забудьте обработать ошибки!
            // 3. Обработайте результат запроса (rows.Scan и т.д.).
            // 4. Сформируйте текстовый ответ для ИИ.
            // 5. Верните результат с помощью mcp.NewToolResultText("Ваш ответ").
            
            // Пример заглушки:
            query := fmt.Sprintf("SHOW TABLES IN SCHEMA %s", schema) // Используем schema из env
            rows, err := db.QueryContext(ctx, query)
            if err != nil {
                log.Printf("Error executing 'SHOW TABLES': %v", err)
                return mcp.NewToolResultError(fmt.Sprintf("query error: %v", err)), nil
            }
            defer rows.Close()
            
            var tables []string
            for rows.Next() {
                 var created_on, name, kind, db_name, schema_name, owner, comment string // Переменные по числу и типу столбцов SHOW TABLES
                 var dropped_on, retention_time interface{} // И другие столбцы
                 // Важно: нужно сканировать все столбцы, которые возвращает SHOW TABLES
                 // Список столбцов может отличаться для разных версий Snowflake!
                 // Лучше сначала выполнить SHOW TABLES вручную и посмотреть столбцы.
                 if err := rows.Scan(&created_on, &name, &kind, &db_name, &schema_name, &dropped_on, &owner, &comment, &retention_time); err != nil { // Упрощенный пример! 
                    log.Printf("Error scanning table row: %v", err)
                    return mcp.NewToolResultError(fmt.Sprintf("scan error: %v", err)), nil
                 }
                 tables = append(tables, name)
            }
            
            if rows.Err() != nil { // Проверяем ошибки после цикла
                 log.Printf("Error after iterating table rows: %v", rows.Err())
                 return mcp.NewToolResultError(fmt.Sprintf("rows iteration error: %v", rows.Err())), nil
            }
            
            responseText := fmt.Sprintf("Доступные таблицы: %s", strings.Join(tables, ", "))
            log.Printf("Sending tool result: %s", responseText)
            return mcp.NewToolResultText(responseText), nil
        })
        log.Println("'list_tables' tool added.") // Не забудьте логировать добавление
        ```
    *   **Внимание:** Приведенный выше код обработчика `list_tables` - это **упрощенный пример**. Команда `SHOW TABLES` возвращает много столбцов, и вам нужно будет правильно их обработать с помощью `rows.Scan`. Рекомендуется сначала выполнить `SHOW TABLES` вручную в Snowflake, чтобы увидеть точный набор столбцов.
5.  **Пересоберите программу:** После внесения изменений в `main.go`, обязательно пересоберите исполняемый файл командой из Шага 4:
    ```bash
    go build -tags netgo -o mcp_snowflake_server main.go
    ```
6.  **Перезапустите ваш MCP клиент:** Чтобы он увидел новый инструмент.

Теперь вы сможете попросить ИИ: "Покажи список таблиц в Snowflake", и он должен будет использовать ваш новый инструмент `list_tables`. 